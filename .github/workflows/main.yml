name: Build and Run HTML with Docker

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'Dockerfile' # Cháº¡y khi Dockerfile thay Ä‘á»•i
      - '.github/workflows/docker-deploy.yml'

jobs:
  build-and-run-docker:
    runs-on: self-hosted # Cháº¡y trÃªn runner cá»§a báº¡n

    steps:
      # BÆ°á»›c 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # BÆ°á»›c 2: Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t my-html-app:latest .
          # Gáº¯n tag theo commit hash Ä‘á»ƒ quáº£n lÃ½ phiÃªn báº£n (tÃ¹y chá»n)
          docker build -t my-html-app:${{ github.sha }} .

      # BÆ°á»›c 3: Dá»«ng vÃ  XÃ³a container cÅ© (náº¿u cÃ³)
      - name: Stop and Remove Old Container
        run: |
          # Kiá»ƒm tra xem container cÃ³ tá»“n táº¡i khÃ´ng, náº¿u cÃ³ thÃ¬ dá»«ng vÃ  xÃ³a
          if [ "$(docker ps -q -f name=my-html-container)" ]; then
              docker stop my-html-container
              docker rm my-html-container
          fi
        # 'continue-on-error: true' Ä‘á»ƒ khÃ´ng bá»‹ lá»—i náº¿u container chÆ°a tá»“n táº¡i
        continue-on-error: true

      # BÆ°á»›c 4: Cháº¡y Container Má»›i
      - name: Run New Docker Container
        run: |
          # Cháº¡y container má»›i tá»« image vá»«a build
          # Ãnh xáº¡ cá»•ng 8080 cá»§a mÃ¡y chá»§ vÃ o cá»•ng 80 cá»§a container
          # (DÃ¹ng 8080 Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t náº¿u báº¡n Ä‘ang cháº¡y Nginx/Apache trÃªn cá»•ng 80)
          # Náº¿u báº¡n khÃ´ng cháº¡y gÃ¬ khÃ¡c trÃªn cá»•ng 80, cÃ³ thá»ƒ dÃ¹ng "80:80"
          docker run -d -p 8080:80 --name my-html-container my-html-app:latest

      # BÆ°á»›c 5: (TÃ¹y chá»n) Dá»n dáº¹p image cÅ©
      - name: Prune Old Docker Images
        run: docker image prune -f

      - name: Deployment Success
        run: echo "ğŸ‰ Docker container 'my-html-container' is running!"